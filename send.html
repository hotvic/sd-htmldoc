<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Enviar um Tutorial - Só Dicas</title>
    <style type="text/css">
        #result {
            color: #FF0000;
            font-weight: bold;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }
        fieldset {
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }
    </style>
    <script src="js/sha512.js" type="text/javascript"></script>
    <script type="text/javascript">
        function updateHint(user, password, blocked) {
            var u   = document.getElementById('uhint');
            var p   = document.getElementById('phint');
            var red = '<span style="color: #FF0000;">';
            var gre = '<span style="color: #00FF00;">';
            var blu = '<span style="color: #0000FF;">';
            var end = '</span>';

            if ( user !== false && password === false && blocked == false ){
                if ( user == 0 )
                    u.innerHTML = blu + 'Usuário incorreto!' + end;
                else if ( user == 1 )
                    u.innerHTML = gre + 'Usuário correto!' + end; 
                else if ( user ==  2)
                    u.innerHTML = red + 'Usuário bloqueado!' + end;
            } else if ( user !== false && password !== false && blocked == false ) {
                if ( user == 0 && password == 0 ) {
                    u.innerHTML = blu + 'Usuário incorreto!' + end;
                    p.innerHTML = blu + 'Senha incorreta!' + end;
                } else if ( user == 1 && password == 0 ) {
                    u.innerHTML = gre + 'Usuário correto!' + end;
                    p.innerHTML = red + 'Senha incorreta!' + end;
                } else if ( user == 1 && password == 1 ) {
                    u.innerHTML = gre + 'Usuário correto!' + end;
                    p.innerHTML = gre + 'Senha correta!' + end;
                } else if ( user == 2 ) {
                    u.innerHTML = red + 'Usuário bloqueado!' + end;
                    p.innerHTML = red + 'Usuário bloqueado!' + end;
                }
            } else if ( user !== false && password !== false && blocked == true ){
                u.innerHTML = red + 'Usuário bloqueado!' + end;
            }
        }
        function checkUser(user) {
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.onreadystatechange = function(){
                if ( xmlhttp.readyState == 4 && xmlhttp.status == 200 ){ 
                    if ( xmlhttp.responseText == "0" ){
                        updateHint(0, false, false);
                    } else if ( xmlhttp.responseText == "1" ){
                        updateHint(1, false, false);
                    }
                }
            }
            xmlhttp.open("GET", "upload.php?action=check&user=" + user, true);
            xmlhttp.send();
        }
        function checkPass(user, pwd) {
            var sha512  = hex_sha512(pwd);
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.onreadystatechange = function(){
                if ( xmlhttp.readyState == 4 && xmlhttp.status == 200 ){
                    if ( xmlhttp.responseText == "0" ) {
                        updateHint(0, 0, false);
                        window.cuser = false;
                        window.cpass = false;
                    } else if ( xmlhttp.responseText == "1" ) {
                        updateHint(1, 0, false);
                        window.cuser = true;
                        window.cpass = false;
                    } else if ( xmlhttp.responseText == "2" ) {
                        updateHint(1, 1, false);
                        window.cuser = true;
                        window.cpass = true;
                    }
                    // TODO:
                    //  write 'else if' for blocked users!
                }
            }
            xmlhttp.open("GET", "upload.php?action=check&user=" + user + "&pass=" + sha512, true);
            xmlhttp.send();
        }
        function checkform() {
            errmsg  = "";
            errflag = false;
            frm = document.forms["sendtuto"];

            if ( frm.elements["tuto"].value == "" ){
                errmsg += "Por favor, forneça um nome ao Tutorial!\n<br>";
                errflag = true;
            }
            if ( frm.elements["user"].value == "" ){
                errmsg += "Usuário invalido!\n<br>";
                errflag = true;
            }
            if ( frm.elements["pwd"].value == "" ){
                errmsg += "Senha invalida!\n<br>";
                errflag = true;
            }
            if ( frm.elements["file"].value == "" ){
                errmsg += "Por favor, selecione um arquivo!\n<br>";
                errflag = true;
            }
            if ( frm.elements["user"].value != "" && frm.elements["pwd"].value != "" && ! errflag ){
                if ( window.cuser && window.cpass == false ) {
                    errmsg += "Você informou um usuário existente, portanto deve informar a senha cadastrada!\n<br>";
                    errflag = true;
                }
            }

            if ( errflag ){
                html = '<span id="errmsg">' + errmsg + '</span>';

                document.getElementById("result").innerHTML = html;

                return false;
            }
            frm.elements["pwd"].value = hex_sha512(frm.elements["pwd"].value);
            return true;
        }
    </script>
</head>
<body>
    <form name="sendtuto" action="upload.php?action=upload" enctype="multipart/form-data" method="POST" onsubmit="return checkform();">
    <fieldset>
        <legend>Enviar Tutorial</legend>
        <table><tbody>
        <tr>
            <th><span style="color: #FF0000;"> * </span><label>Nome do Tutorial:</label></th>
            <td><input type="text" name="tuto"></td>
        </tr>
        <tr>
            <th><span style="color: #FF0000;"> * </span><label title="Nome de usuário, caso não exista será criado.">Usuário:</label></th>
            <td><input type="text" name="user" onkeyup="checkUser(this.value)"></td>
            <td id="uhint"></td>
        </tr>
        <tr>
            <th><span style="color: #FF0000;"> * </span><label title="Em caso de usuário existente a senha deve coincidir com a cadastrada.">Senha:</label></th>
            <td><input type="password" name="pwd" onchange="checkPass(this.form.user.value, this.value)"></td>
            <td id="phint"></td>
        </tr>
        <tr>
            <th><span style="color: #FF0000;"> * </span><label>Arquivo:</label></th>
            <td><input type="file" name="file"></td>
        </tr>
        <tr>
            <th><label title="Detalhes Adicionais, exemplo: Copyright">Detalhes Adicionais:</label></th>
            <td><textarea name="details" cols="36" rows="5"></textarea></td>
        </tr>
        <tr>
            <td></td>
            <td><input type="submit" id="bntsend" value="Enviar"></td>
        </tr>
        </tbody></table>
        <div id="result"></div>
    </fieldset>
</body>
</html>
